---
// ProductModal.astro
---

<div id="product-modal" class="modal-root hidden">
    <!-- Backdrop -->
    <div id="modal-overlay" class="modal-backdrop opacity-0"></div>

    <!-- Close button — OUTSIDE the scrolling card so it never scrolls away -->
    <button id="close-modal" class="modal-close" aria-label="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
    </button>

    <!-- Card (this div scrolls on mobile) -->
    <div id="modal-content" class="modal-card scale-95 opacity-0">

        <!-- ── Left: Image Gallery ───────────────────── -->
        <div class="modal-image-col" id="modal-gallery">
            <!-- Slides container -->
            <div class="gallery-track" id="gallery-track">
                <!-- slides injected by JS -->
            </div>

            <!-- Arrows (hidden when only 1 image) -->
            <button class="gallery-arrow gallery-prev" id="gallery-prev" aria-label="Previous image">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
            </button>
            <button class="gallery-arrow gallery-next" id="gallery-next" aria-label="Next image">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
            </button>

            <!-- Dot indicators (hidden when only 1 image) -->
            <div class="gallery-dots" id="gallery-dots"></div>
        </div>

        <!-- ── Right: Details ───────────────────────── -->
        <div class="modal-details-col">

            <!-- Header -->
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">Product Name</h2>
                <p id="modal-accords" class="modal-accords">Accords</p>
            </div>

            <!-- Size Selector -->
            <div class="size-row">
                <button id="size-6ml-btn" class="size-pill active" data-size="6ML">6 ML</button>
                <button id="size-15ml-btn" class="size-pill" data-size="15ML">15 ML</button>
            </div>

            <!-- Notes Table -->
            <div class="notes-table">
                <div class="notes-row">
                    <span class="notes-label">Top Notes</span>
                    <span id="modal-top-notes" class="notes-value">—</span>
                </div>
                <div class="notes-row">
                    <span class="notes-label">Heart Notes</span>
                    <span id="modal-heart-notes" class="notes-value">—</span>
                </div>
                <div class="notes-row">
                    <span class="notes-label">Base Notes</span>
                    <span id="modal-base-notes" class="notes-value">—</span>
                </div>
                <div class="notes-divider"></div>
                <div class="notes-row">
                    <span class="notes-label">Longevity</span>
                    <span id="modal-longevity" class="notes-value">—</span>
                </div>
                <div class="notes-row">
                    <span class="notes-label">Projection</span>
                    <span id="modal-projection" class="notes-value">—</span>
                </div>
            </div>

            <!-- Price -->
            <div class="modal-price-wrap">
                <span class="modal-currency">৳</span>
                <span id="modal-price" class="modal-price-num">0</span>
            </div>

            <!-- CTA Buttons -->
            <div class="modal-cta-grid">
                <a id="whatsapp-btn" href="#" target="_blank" rel="noopener" class="cta-btn cta-wa">
                    <svg class="cta-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    <span>Order via WhatsApp</span>
                </a>
                <a id="facebook-btn" href="#" target="_blank" rel="noopener" class="cta-btn cta-fb">
                    <svg class="cta-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a8.68 8.68 0 0 1 1.141.195v3.325a8.623 8.623 0 0 0-.653-.036c-2.148 0-2.797 1.603-2.797 2.87v1.12h5.374l-.275 3.667h-4.986v7.98c-5.08 0-6.708-4.526-6.708-4.526h1.274z"/>
                    </svg>
                    <span>Order via Messenger</span>
                </a>
            </div>

        </div><!-- /details -->
    </div><!-- /card -->
</div>

<style>
/* ─── Root overlay ───────────────────────────────────── */
.modal-root {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
}
.modal-root.hidden { display: none; }

.modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.72);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    transition: opacity 0.3s ease;
}

/* ─── Card ────────────────────────────────────────────── */
.modal-card {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 880px;
    max-height: 92vh;
    overflow-y: auto;
    border-radius: 20px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    transition: transform 0.35s cubic-bezier(0.23,1,0.32,1), opacity 0.35s ease;
    overscroll-behavior: contain;

    background: #1a1714;
    box-shadow: 0 30px 80px rgba(0,0,0,0.7), 0 0 0 1px rgba(198,167,94,0.08);
}
@media (max-width: 640px) {
    .modal-card {
        display: flex;
        flex-direction: column;
        overflow-y: auto;              /* WHOLE card scrolls as one unit */
        -webkit-overflow-scrolling: touch;
        overflow-x: hidden;
        max-height: 90vh;
    }
}

/* ─── Close button (outside the scrolling card → always fixed) ─────────── */
.modal-close {
    position: fixed;
    top: 14px;
    right: 14px;
    z-index: 10001;   /* above modal backdrop + card */
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
    /* dark pill so it reads against any background */
    background: rgba(20,20,20,0.65);
    color: #fff;
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    box-shadow: 0 2px 12px rgba(0,0,0,0.35);
}
.modal-close:hover {
    background: rgba(198,167,94,0.95);
    color: #fff;
    transform: rotate(90deg);
}

/* ─── Image column ──────────────────────────────────── */
.modal-image-col {
    position: relative;
    min-height: 280px;
    background: #131110;
    border-radius: 20px 0 0 20px;
    overflow: hidden;
    position: relative;   /* needed for absolute arrows */
}
/* Mobile: full 1:1 square image — card scrolls so details remain accessible */
@media (max-width: 640px) {
    .modal-image-col {
        border-radius: 20px 20px 0 0;
        width: 100%;
        height: auto;          /* let aspect-ratio control height */
        aspect-ratio: 1 / 1;   /* perfect square, image never cropped */
        flex-shrink: 0;        /* never compress this */
    }
    /* gallery track must fill the aspect-ratio-sized parent */
    .gallery-track {
        position: absolute;
        inset: 0;
        height: 100%;
    }
    .modal-image-col { position: relative; } /* ensure absolute track works */
}


/* ─── Gallery track (slides strip) ──────────────────── */
.gallery-track {
    display: flex;
    width: 100%;
    height: 100%;
    transition: transform 0.35s cubic-bezier(0.23, 1, 0.32, 1);
}
:global(.gallery-slide) {
    flex: 0 0 100%;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    box-sizing: border-box;
    position: relative;
    overflow: hidden;
}

/* Blurred background fill for landscape images */
:global(.gallery-slide-bg) {
    position: absolute;
    inset: -20px;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    filter: blur(6px) saturate(0.7) brightness(0.4);
    transform: scale(1.2);
    z-index: 0;
}

:global(.gallery-slide img) {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;   /* show full product, never cropped */
    display: block;
    border-radius: 4px;
    position: relative;
    z-index: 1;
}

/* ─── Arrows ─────────────────────────────────────────── */
.gallery-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 5;
    width: 34px;
    height: 34px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.45);
    color: #fff;
    backdrop-filter: blur(4px);
    transition: background 0.2s ease, transform 0.2s ease;
}
.gallery-arrow:hover {
    background: rgba(198,167,94,0.9);
    transform: translateY(-50%) scale(1.1);
}
.gallery-prev { left: 10px; }
.gallery-next { right: 10px; }
.gallery-arrow.hidden { display: none; }

/* ─── Dot indicators ─────────────────────────────────── */
.gallery-dots {
    position: absolute;
    bottom: 10px;
    left: 0; right: 0;
    display: flex;
    justify-content: center;
    gap: 6px;
}
.gallery-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: rgba(255,255,255,0.5);
    border: none;
    cursor: pointer;
    padding: 0;
    transition: background 0.2s ease, transform 0.2s ease;
}
.gallery-dot.active {
    background: #c6a75e;
    transform: scale(1.3);
}
.gallery-dots.hidden { display: none; }


/* ─── Details column ────────────────────────────────── */
.modal-details-col {
    padding: 28px 28px 28px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    /* On desktop, details may need their own scroll if card can't grow */
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    flex: 1;
    min-height: 0;
}
@media (max-width: 640px) {
    .modal-details-col {
        padding: 18px 16px 24px;
        gap: 12px;
        /* Card scrolls — details just flow, no independent scroll needed */
        overflow-y: visible;
        flex: none;
        min-height: auto;
    }
}


/* ─── Header ────────────────────────────────────────── */
.modal-header { display: flex; flex-direction: column; gap: 6px; }

.modal-title {
    font-family: serif;
    font-size: clamp(1.5rem, 3vw, 2rem);
    font-weight: 400;
    line-height: 1.2;
    margin: 0;
    color: #f0ede6;
}

.modal-accords {
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    margin: 0;
    color: #c6a75e;
}

/* ─── Size pills ────────────────────────────────────── */
.size-row {
    display: flex;
    gap: 10px;
}
.size-pill {
    flex: 1;
    padding: 10px 0;
    border-radius: 8px;
    border: 1.5px solid rgba(255,255,255,0.12);
    background: transparent;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    transition: all 0.25s ease;
    color: #aaa;
}
.size-pill.active {
    background: linear-gradient(135deg, #c6a75e, #e8c87a);
    border-color: transparent;
    color: #1a1200;
    box-shadow: 0 4px 14px rgba(198,167,94,0.4);
}
.size-pill:not(.active):hover {
    border-color: #c6a75e;
    color: #c6a75e;
}

/* ─── Notes table ───────────────────────────────────── */
.notes-table {
    display: flex;
    flex-direction: column;
    gap: 0;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.07);
}

.notes-row {
    display: grid;
    grid-template-columns: 96px 1fr;   /* fixed label width → perfect alignment */
    align-items: baseline;
    gap: 12px;
    padding: 9px 14px;
}
.notes-row:nth-child(odd) {
    background: rgba(255,255,255,0.03);
}

.notes-label {
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    white-space: nowrap;
    color: #c6a75e;
}
.notes-value {
    font-size: 0.85rem;
    line-height: 1.45;
    color: #b0b0b0;
}

.notes-divider {
    height: 1px;
    background: rgba(0,0,0,0.07);
    margin: 2px 0;
}

/* ─── Price ─────────────────────────────────────────── */
.modal-price-wrap {
    display: flex;
    align-items: baseline;
    gap: 3px;
    font-size: 1.8rem;
    font-weight: 600;
    color: #f0ede6;
}
.modal-currency {
    font-size: 1.2rem;
    color: #c6a75e;
}
.modal-price-num { color: inherit; }

/* ─── CTA buttons ───────────────────────────────────── */
.modal-cta-grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: auto;
}

.cta-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 13px 20px;
    border-radius: 10px;
    text-decoration: none;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #fff;
    transition: filter 0.25s ease, transform 0.2s ease, box-shadow 0.25s ease;
}
.cta-btn:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
}
.cta-icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
}

/* WhatsApp — green gradient */
.cta-wa {
    background: linear-gradient(135deg, #1aad52 0%, #25d366 100%);
    box-shadow: 0 4px 16px rgba(37,211,102,0.35);
}
.cta-wa:hover { box-shadow: 0 6px 22px rgba(37,211,102,0.5); }

/* Messenger — blue gradient */
.cta-fb {
    background: linear-gradient(135deg, #1565c0 0%, #1877f2 100%);
    box-shadow: 0 4px 16px rgba(24,119,242,0.35);
}
.cta-fb:hover { box-shadow: 0 6px 22px rgba(24,119,242,0.5); }

/* ─── Scrollbar in modal ────────────────────────────── */
.modal-card::-webkit-scrollbar,
.modal-details-col::-webkit-scrollbar { width: 4px; }
.modal-card::-webkit-scrollbar-track,
.modal-details-col::-webkit-scrollbar-track { background: transparent; }
.modal-card::-webkit-scrollbar-thumb,
.modal-details-col::-webkit-scrollbar-thumb {
    background: rgba(198,167,94,0.4);
    border-radius: 2px;
}
</style>

<script>
    const modal    = document.getElementById('product-modal');
    const overlay  = document.getElementById('modal-overlay');
    const content  = document.getElementById('modal-content');
    const closeBtn = document.getElementById('close-modal');

    let currentProductData: any = null;
    let selectedSize = '6ML';

    /* ── gallery state ── */
    let galleryImages: string[] = [];
    let galleryIndex  = 0;

    const track    = document.getElementById('gallery-track') as HTMLElement;
    const prevBtn  = document.getElementById('gallery-prev') as HTMLButtonElement;
    const nextBtn  = document.getElementById('gallery-next') as HTMLButtonElement;
    const dotsWrap = document.getElementById('gallery-dots') as HTMLElement;

    function buildGallery(images: string[], title: string) {
        galleryImages = images;
        galleryIndex  = 0;

        // Build slides (with blurred bg for landscape images)
        track.innerHTML = images.map(src => `
            <div class="gallery-slide">
                <div class="gallery-slide-bg" style="background-image: url('${src}')"></div>
                <img src="${src}" alt="${title}" loading="lazy" />
            </div>
        `).join('');

        // Build dots
        dotsWrap.innerHTML = images.map((_, i) =>
            `<button class="gallery-dot${i === 0 ? ' active' : ''}" data-i="${i}" aria-label="Image ${i+1}"></button>`
        ).join('');

        // Show/hide arrows and dots
        const multi = images.length > 1;
        prevBtn.classList.toggle('hidden', !multi);
        nextBtn.classList.toggle('hidden', !multi);
        dotsWrap.classList.toggle('hidden', !multi);

        goToSlide(0);
    }

    function goToSlide(i: number) {
        const total = galleryImages.length;
        galleryIndex = (i + total) % total;
        track.style.transform = `translateX(-${galleryIndex * 100}%)`;

        // Update dots
        dotsWrap.querySelectorAll<HTMLElement>('.gallery-dot').forEach((dot, idx) => {
            dot.classList.toggle('active', idx === galleryIndex);
        });
    }

    /* ── helpers ── */
    const set = (id: string, val: string) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
    };

    function updatePriceAndLinks() {
        if (!currentProductData) return;
        const price = selectedSize === '6ML'
            ? currentProductData.price_6ml
            : currentProductData.price_15ml;
        set('modal-price', price);

        const waBtn = document.getElementById('whatsapp-btn') as HTMLAnchorElement;
        if (waBtn) {
            const msg = `I want to order ${currentProductData.title} (${selectedSize})`;
            waBtn.href = `https://wa.me/8801571316610?text=${encodeURIComponent(msg)}`;
        }
        const fbBtn = document.getElementById('facebook-btn') as HTMLAnchorElement;
        if (fbBtn) fbBtn.href = 'https://www.facebook.com/scenterperfumes';
    }

    function updateSizePills() {
        document.querySelectorAll<HTMLElement>('.size-pill').forEach(pill => {
            pill.classList.toggle('active', pill.dataset.size === selectedSize);
        });
    }

    function openModal(productData: any) {
        if (!modal || !overlay || !content) return;
        currentProductData = productData;
        selectedSize = '6ML';

        set('modal-title',       productData.title);
        set('modal-accords',     productData.accords);
        set('modal-top-notes',   productData.top_notes);
        set('modal-heart-notes', productData.heart_notes);
        set('modal-base-notes',  productData.base_notes);
        set('modal-longevity',   productData.longevity);
        set('modal-projection',  productData.projection);

        // Build gallery: use images[] array if present, else fall back to image
        const imgs: string[] = (productData.images && productData.images.length > 0)
            ? [productData.image, ...productData.images]
            : [productData.image];
        buildGallery(imgs, productData.title);

        updatePriceAndLinks();
        updateSizePills();

        if (productData.slug) history.pushState(null, '', '#' + productData.slug);

        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
            overlay?.classList.remove('opacity-0');
            content?.classList.remove('opacity-0', 'scale-95');
            content?.classList.add('opacity-100', 'scale-100');
        });
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        if (!modal || !overlay || !content) return;
        overlay.classList.add('opacity-0');
        content.classList.remove('opacity-100', 'scale-100');
        content.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            history.pushState(null, '', window.location.pathname);
        }, 300);
    }

    /* ── event wiring ── */
    document.addEventListener('DOMContentLoaded', () => {
        // Open on card click
        document.body.addEventListener('click', (e: Event) => {
            const target = (e.target as Element).closest('.view-details-btn');
            if (target) {
                e.preventDefault();
                const data = JSON.parse(target.getAttribute('data-product') || '{}');
                openModal(data);
            }
        });

        // Gallery arrows
        prevBtn?.addEventListener('click', () => goToSlide(galleryIndex - 1));
        nextBtn?.addEventListener('click', () => goToSlide(galleryIndex + 1));

        // Dot clicks
        dotsWrap?.addEventListener('click', (e: Event) => {
            const dot = (e.target as Element).closest<HTMLElement>('.gallery-dot');
            if (dot?.dataset.i) goToSlide(Number(dot.dataset.i));
        });

        // Size pills
        document.querySelectorAll<HTMLElement>('.size-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                const size = pill.dataset.size;
                if (size && size !== selectedSize) {
                    selectedSize = size;
                    updatePriceAndLinks();
                    updateSizePills();
                }
            });
        });

        closeBtn?.addEventListener('click', closeModal);
        overlay?.addEventListener('click', (e: Event) => {
            if (e.target === overlay) closeModal();
        });

        document.addEventListener('keydown', (e: KeyboardEvent) => {
            if (modal?.classList.contains('hidden')) return;
            if (e.key === 'Escape')      closeModal();
            if (e.key === 'ArrowLeft')   goToSlide(galleryIndex - 1);
            if (e.key === 'ArrowRight')  goToSlide(galleryIndex + 1);
        });

        // Open from URL hash
        if (window.location.hash) {
            const btn = document.querySelector(`.view-details-btn[href="${window.location.hash}"]`) as HTMLAnchorElement;
            if (btn) btn.click();
        }
    });
</script>
